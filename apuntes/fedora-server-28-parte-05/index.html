<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="generator" content="Pelican Static Site Generator, Powered by Python">
    <meta name="description" content="Vamos a configurar un proxy con Squid.">
    <meta name="keywords" content="fedora, gnu linux, servidores, software libre, apuntes">
    <meta name="author" content="Guillermo Valdés Lozano (guivaloz)">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@guivaloz">
    <meta name="twitter:title" content="Instalación de Fedora Server 28, parte 5, proxy Squid">
    <meta name="twitter:description" content="Vamos a configurar un proxy con Squid.">
    <meta name="twitter:image" content="https://movimientolibre.com/apuntes/fedora-server-28-parte-05/fedora-logo-icon.png">
    <meta property="og:title" content="Instalación de Fedora Server 28, parte 5, proxy Squid">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://movimientolibre.com/apuntes/fedora-server-28-parte-05/">
    <meta property="og:image" content="https://movimientolibre.com/apuntes/fedora-server-28-parte-05/fedora-logo-icon.png">
    <meta property="og:description" content="Vamos a configurar un proxy con Squid.">
    <meta property="og:site_name" content="Movimiento Libre">
    <title>Instalación de Fedora Server 28, parte 5, proxy Squid - Movimiento Libre</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://movimientolibre.com/favicon.ico">
    <link rel="icon" href="https://movimientolibre.com/theme/images/icon-hires.png" sizes="192x192">
    <link rel="icon" href="https://movimientolibre.com/theme/images/icon-normal.png" sizes="128x128">
    <link rel="apple-touch-icon" href="https://movimientolibre.com/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" href="https://movimientolibre.com/theme/images/apple-touch-icon-76x76.png" sizes="76x76">
    <link rel="apple-touch-icon" href="https://movimientolibre.com/theme/images/apple-touch-icon-120x120.png" sizes="120x120">
    <link rel="apple-touch-icon" href="https://movimientolibre.com/theme/images/apple-touch-icon-152x152.png" sizes="152x152">
    <link rel="apple-touch-icon" href="https://movimientolibre.com/theme/images/apple-touch-icon-180x180.png" sizes="180x180">
    <link rel="alternate" href="https://movimientolibre.com/feeds/all.rss.xml" type="application/rss+xml" title="Movimiento Libre Full RSS Feed" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74263253-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-74263253-1');
    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap">
    <link rel="stylesheet" href="https://movimientolibre.com/theme/css/movimiento-libre.css">
</head>
<body>
    <nav class="navbar navbar-expand-md fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="https://movimientolibre.com/"><i class="fa fa-home"></i></a>
            <button class="navbar-toggler movimientolibre-navbar-toggler" type="button" data-toggle="collapse" data-target="#navBootstrap4" aria-controls="navBootstrap4" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navBootstrap4">
                <ul class="navbar-nav mr-auto">
                    <li><a class="nav-link" href="https://movimientolibre.com/category/apuntes.html">Apuntes</a></li>
                    <li><a class="nav-link" href="https://movimientolibre.com/category/articulos.html">Artículos</a></li>
                    <li><a class="nav-link" href="https://movimientolibre.com/category/presentaciones.html">Presentaciones</a></li>
                    <li><a class="nav-link" href="https://movimientolibre.com/portafolio/contacto/index.html">Contacto</a></li>
                </ul>
                <ul class="navbar-nav movimientolibre-navbar-icons">
                    <li><a class="movimientolibre-navbar-icon-link" href="https://twitter.com/guivaloz/" target="_blank"><i class="fab fa-twitter-square"></i></a></li>
                    <li><a class="movimientolibre-navbar-icon-link" href="https://www.facebook.com/movimientolibrepuntocom/" target="_blank"><i class="fab fa-facebook-square"></i></a></li>
                    <li><a class="movimientolibre-navbar-icon-link" href="https://github.com/guivaloz" target="_blank"><i class="fab fa-github-square"></i></a></li>
                    <li><a class="movimientolibre-navbar-icon-link" href="https://movimientolibre.com/feeds/all.rss.xml"><i class="fa fa-rss-square"></i></a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <header>
            <div class="jumbotron head-welcome" itemscope itemtype="http://schema.org/Organization">
                <h1 class="jumbotron-heading head-site-name" itemprop="name">Movimiento Libre</h1>
                <p class="head-site-description" itemprop="description">Plataforma de divulgación de conocimiento libre por Ing. Guillermo Valdés Lozano (guivaloz)</p>
            </div>
        </header>
        <div class="row">
            <div class="col-md-8">
                <article class="article-post">
                    <script type="application/ld+json">
                        {
                            "@context": "http://schema.org",
                            "@type": "Article",
                            "publisher": {
                                "@type": "Organization",
                                "name": "Movimiento Libre",
                                "logo": {
                                    "@type": "ImageObject",
                                    "url": "https://movimientolibre.com/theme/images/movimientolibre.png"
                                },
                                "url": "https://movimientolibre.com"
                            },
                            "author": "Guillermo Valdés Lozano (guivaloz)",
                            "name": "Instalación de Fedora Server 28, parte 5, proxy Squid",
                            "headline": "Instalación de Fedora Server 28, parte 5, proxy Squid",
                            "description": "Vamos a configurar un proxy con Squid.",
                            "dateCreated": "2018-06-24 22:15:00-05:00",
                            "datePublished": "2018-06-24 22:15:00-05:00",
                            "dateModified": "2018-06-24 22:15:00-05:00",
                            "image": "https://movimientolibre.com/apuntes/fedora-server-28-parte-05/fedora-logo-icon.png",
                            "url": "https://movimientolibre.com/apuntes/fedora-server-28-parte-05/"
                        }
                    </script>
                    <h2 class="article-post-title">Instalación de Fedora Server 28, parte 5, proxy Squid</h2>
<p>Vamos a configurar un proxy con Squid.</p>
                    <p class="article-post-meta">24 junio 2018</p>
<h3>Squid - archivos de configuración</h3>
<p>Instale Squid...</p>
<div class="highlight"><pre><span></span><code><span class="err"># dnf install squid</span>
</code></pre></div>


<p>En el directorio <code>/etc/squid</code> se deben de encontrar los archivos de configuración.</p>
<div class="highlight"><pre><span></span><code><span class="err"># cd /etc/squid</span>
</code></pre></div>


<p>Ahí debe estar el archivo <code>squid.conf</code>. Éste puede cargar otros archivos <em>conf</em>, <em>txt</em>, <em>css</em>, etc.</p>
<p>Como puede ser muy extensa la configuración de Squid, vamos a dividir la configuración de <code>squid.conf</code> en archivos según su propósito. Comienze por el principal que cargará los demás...</p>
<div class="highlight"><pre><span></span><code><span class="err"># nano squid.conf</span>
</code></pre></div>


<p>Con este contenido...</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">Correo</span><span class="w"> </span><span class="n">electronico</span><span class="w"></span>
<span class="n">cache_mgr</span><span class="w"> </span><span class="n">webmaster</span><span class="nv">@miredlocal</span><span class="p">.</span><span class="n">lan</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Nombre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">este</span><span class="w"> </span><span class="n">servidor</span><span class="w"></span>
<span class="n">visible_hostname</span><span class="w"> </span><span class="n">miproxy</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Archivos</span><span class="w"> </span><span class="n">separados</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">configuracion</span><span class="w"></span>
<span class="k">include</span><span class="w"> </span><span class="ss">&quot;/etc/squid/squid-01-declaraciones.conf&quot;</span><span class="w"></span>
<span class="k">include</span><span class="w"> </span><span class="ss">&quot;/etc/squid/squid-02-accesos.conf&quot;</span><span class="w"></span>
<span class="k">include</span><span class="w"> </span><span class="ss">&quot;/etc/squid/squid-03-opciones.conf&quot;</span><span class="w"></span>
<span class="k">include</span><span class="w"> </span><span class="ss">&quot;/etc/squid/squid-04-balanceo.conf&quot;</span><span class="w"></span>
</code></pre></div>


<h3>Squid - declaraciones</h3>
<p>Cree <code>squid-01-declaraciones.conf</code>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># nano squid-01-declaraciones.conf</span>
</code></pre></div>


<p>Ajuste el contenido de acuerdo a sus necesidades...</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">Puerto</span> <span class="n">para</span> <span class="n">permitir</span> <span class="n">https</span>
<span class="n">acl</span> <span class="n">SSLPorts</span>  <span class="n">port</span>  <span class="mi">443</span>        <span class="o">#</span> <span class="n">https</span>
<span class="n">acl</span> <span class="n">SSLPorts</span>  <span class="n">port</span> <span class="mi">5222</span>        <span class="o">#</span> <span class="p">.</span><span class="n">whatsapp</span><span class="p">.</span><span class="n">com</span><span class="p">,</span> <span class="p">.</span><span class="n">whatsapp</span><span class="p">.</span><span class="n">net</span>
<span class="n">acl</span> <span class="n">SSLPorts</span>  <span class="n">port</span> <span class="mi">5228</span>        <span class="o">#</span> <span class="n">mtalk</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span>

<span class="o">#</span> <span class="n">Puertos</span> <span class="n">que</span> <span class="n">se</span> <span class="n">pueden</span> <span class="n">usar</span>
<span class="n">acl</span> <span class="n">SafePorts</span> <span class="n">port</span>   <span class="mi">21</span>        <span class="o">#</span> <span class="n">ftp</span>
<span class="n">acl</span> <span class="n">SafePorts</span> <span class="n">port</span>   <span class="mi">70</span>        <span class="o">#</span> <span class="n">gopher</span>
<span class="n">acl</span> <span class="n">SafePorts</span> <span class="n">port</span>   <span class="mi">80</span>        <span class="o">#</span> <span class="n">http</span>
<span class="n">acl</span> <span class="n">SafePorts</span> <span class="n">port</span>  <span class="mi">443</span>        <span class="o">#</span> <span class="n">https</span>
<span class="n">acl</span> <span class="n">SafePorts</span> <span class="n">port</span> <span class="mi">1025</span><span class="o">-</span><span class="mi">65535</span>  <span class="o">#</span> <span class="n">unregistered</span> <span class="n">ports</span>

<span class="o">#</span> <span class="n">Declaración</span> <span class="k">connect</span>
<span class="n">acl</span> <span class="k">CONNECT</span> <span class="k">method</span> <span class="k">CONNECT</span>

<span class="o">#</span> <span class="n">Desde</span> <span class="n">y</span> <span class="n">hacia</span> <span class="n">Localhost</span>
<span class="n">acl</span> <span class="n">DesdeLocalhost</span>    <span class="n">src</span>        <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">8</span>
<span class="n">acl</span> <span class="n">HaciaLocalhost</span>    <span class="n">dst</span>        <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">8</span>

<span class="o">#</span> <span class="n">Desde</span> <span class="n">y</span> <span class="n">hacia</span> <span class="n">LAN</span>
<span class="n">acl</span> <span class="n">DesdeLAN</span>          <span class="n">src</span>        <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
<span class="n">acl</span> <span class="n">HaciaLAN</span>          <span class="n">dst</span>        <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span>

<span class="o">#</span> <span class="n">Definiciones</span> <span class="n">de</span> <span class="n">sitios</span>
<span class="n">acl</span> <span class="n">SitiosPermitidos</span>  <span class="n">dstdomain</span>  <span class="ss">&quot;/etc/squid/sitios-permitidos.txt&quot;</span>
<span class="n">acl</span> <span class="n">SitiosProhibidos</span>  <span class="n">dstdomain</span>  <span class="ss">&quot;/etc/squid/sitios-prohibidos.txt&quot;</span>

<span class="o">#</span> <span class="n">Definiciones</span> <span class="n">de</span> <span class="n">expresiones</span> <span class="n">regulares</span> <span class="n">sobre</span> <span class="n">publicidad</span>
<span class="n">acl</span> <span class="n">RegExpPublicidad</span>  <span class="n">dstdom_regex</span> <span class="o">-</span><span class="n">i</span> <span class="ss">&quot;/etc/squid/regexp-publicidad.txt&quot;</span>

<span class="o">#</span> <span class="n">Audio</span> <span class="n">MP3</span>
<span class="n">acl</span> <span class="n">AudioMP3Mime</span>      <span class="n">rep_mime_type</span>  <span class="n">audio</span><span class="o">/</span><span class="n">mpeg</span>
<span class="n">acl</span> <span class="n">AudioMP3RegExp</span>    <span class="n">urlpath_regex</span>  <span class="err">\</span><span class="p">.</span><span class="n">mp3$</span>

<span class="o">#</span> <span class="n">Video</span> <span class="n">MPEG4</span> <span class="p">(</span><span class="n">MPG4</span><span class="p">)</span>
<span class="n">acl</span> <span class="n">VideoMP4Mime</span>      <span class="n">rep_mime_type</span>  <span class="n">video</span><span class="o">/</span><span class="n">mp4</span> <span class="n">video</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">mp4</span>
<span class="n">acl</span> <span class="n">VideoMP4RegExp</span>    <span class="n">urlpath_regex</span>  <span class="err">\</span><span class="p">.</span><span class="n">mp4$</span>

<span class="o">#</span> <span class="n">Flash</span> <span class="n">Video</span> <span class="n">Format</span> <span class="p">(</span><span class="n">FLV</span><span class="p">)</span>
<span class="n">acl</span> <span class="n">FlashVideoMime</span>    <span class="n">rep_mime_type</span>  <span class="n">video</span><span class="o">/</span><span class="n">flv</span> <span class="n">video</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">flv</span>
<span class="n">acl</span> <span class="n">FlashVideoRegExp</span>  <span class="n">urlpath_regex</span>  <span class="err">\</span><span class="p">.</span><span class="n">flv$</span>

<span class="o">#</span> <span class="n">Flash</span> <span class="k">General</span> <span class="n">Media</span> <span class="n">Scripts</span> <span class="p">(</span><span class="n">SWF</span><span class="p">)</span>
<span class="n">acl</span> <span class="n">FlashMime</span>         <span class="n">rep_mime_type</span>  <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">shockwave</span><span class="o">-</span><span class="n">flash</span>
<span class="n">acl</span> <span class="n">FlashRegExp</span>       <span class="n">urlpath_regex</span>  <span class="err">\</span><span class="p">.</span><span class="n">swf$</span>
</code></pre></div>


<h3>Squid - accesos</h3>
<p>Cree <code>squid-02-accesos.conf</code>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># nano squid-02-accesos.conf</span>
</code></pre></div>


<p>Ajuste el contenido de acuerdo a sus necesidades...</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">El</span> <span class="n">administrador</span> <span class="n">del</span> <span class="k">cache</span> <span class="s1">&#39;manager&#39;</span> <span class="n">solo</span> <span class="n">lo</span> <span class="n">hará</span> <span class="n">localhost</span>
<span class="n">http_access</span>         <span class="n">allow</span>  <span class="n">DesdeLocalhost</span> <span class="n">manager</span>
<span class="n">http_access</span>         <span class="n">deny</span>                  <span class="n">manager</span>

<span class="o">#</span> <span class="n">NEGAR</span> <span class="n">solicitudes</span> <span class="n">por</span> <span class="n">los</span> <span class="n">puertos</span> <span class="k">NO</span> <span class="n">seguros</span>
<span class="n">http_access</span>         <span class="n">deny</span>   <span class="o">!</span><span class="n">SafePorts</span>

<span class="o">#</span> <span class="n">NEGAR</span> <span class="k">CONNECT</span> <span class="n">a</span> <span class="n">otros</span> <span class="n">puertos</span> <span class="k">NO</span> <span class="n">SSL</span> <span class="n">seguros</span>
<span class="n">http_access</span>         <span class="n">deny</span>   <span class="k">CONNECT</span> <span class="o">!</span><span class="n">SSLPorts</span>

<span class="o">#</span> <span class="n">Es</span> <span class="n">recomendable</span> <span class="n">negar</span> <span class="n">conexiones</span> <span class="n">a</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="err">é</span><span class="n">stas</span> <span class="n">deben</span> <span class="n">hacerce</span> <span class="n">fuera</span> <span class="n">del</span> <span class="n">proxy</span>
<span class="n">http_access</span>         <span class="n">deny</span>   <span class="n">HaciaLocalhost</span>

<span class="o">#</span> <span class="n">NEGAR</span> <span class="n">Adobe</span> <span class="n">Flash</span>
<span class="n">http_access</span>         <span class="n">deny</span>   <span class="n">FlashRegExp</span>

<span class="o">#</span> <span class="n">Permitir</span> <span class="n">sitios</span> <span class="n">permitidos</span>
<span class="n">http_access</span>         <span class="n">allow</span>  <span class="n">SitiosPermitidos</span>

<span class="o">#</span> <span class="n">NEGAR</span> <span class="n">prohibidos</span> <span class="n">y</span> <span class="n">publicidad</span>
<span class="n">http_access</span>         <span class="n">deny</span>   <span class="n">SitiosProhibidos</span>
<span class="n">http_access</span>         <span class="n">deny</span>   <span class="n">RegExpPublicidad</span>

<span class="o">#</span> <span class="n">Permitir</span> <span class="n">todo</span> <span class="n">lo</span> <span class="n">demás</span> <span class="n">a</span> <span class="n">localhost</span>
<span class="n">http_access</span>         <span class="n">allow</span>  <span class="n">DesdeLocalhost</span>

<span class="o">#</span> <span class="n">Permitir</span> <span class="n">equipos</span> <span class="n">LAN</span>
<span class="n">http_access</span>         <span class="n">allow</span>  <span class="n">DesdeLAN</span>

<span class="o">#</span> <span class="n">NEGAR</span> <span class="n">TODO</span> <span class="n">a</span> <span class="n">todos</span> <span class="n">los</span> <span class="n">demás</span>
<span class="n">http_access</span>         <span class="n">deny</span>   <span class="k">all</span>
</code></pre></div>


<h3>Squid - opciones</h3>
<p>Cree <code>squid-03-opciones.conf</code>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># nano squid-03-opciones.conf</span>
</code></pre></div>


<p>Ajuste el contenido de acuerdo a sus necesidades...</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Puerto</span>
<span class="n">http_port</span> <span class="mi">3128</span>

<span class="c1"># Disk cache directory</span>
<span class="c1"># - ufs es el sistema de almacenamiento propio de Squid</span>
<span class="c1"># - /var/cache/squid es la ruta</span>
<span class="c1"># - 8192 es la cantidad en MB, debe tener como maximo 20% menos del tamano de la particion</span>
<span class="c1">#        la partición /var tiene 16 GB, así que 8 GB es la mitad</span>
<span class="c1"># -   64 es L1, el numero de subdirectorios de primer nivel</span>
<span class="c1"># -  256 es L2, el numero de subdirectorios de segundo nivel</span>
<span class="n">cache_dir</span> <span class="n">ufs</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">squid</span> <span class="mi">8192</span> <span class="mi">64</span> <span class="mi">256</span>

<span class="c1"># Tamano maximo por objeto</span>
<span class="n">maximum_object_size</span> <span class="mi">128</span> <span class="n">MB</span>

<span class="c1"># Cantidad de Memoria RAM que se usara antes de escribir en el disco</span>
<span class="n">cache_mem</span> <span class="mi">256</span> <span class="n">MB</span>
<span class="n">cache_replacement_policy</span> <span class="n">heap</span> <span class="n">LFUDA</span>

<span class="c1"># Patrones de archivos y sus tiempos de permanencia en el cache</span>
<span class="n">refresh_pattern</span> <span class="o">^</span><span class="n">ftp</span><span class="p">:</span>             <span class="mi">1440</span>  <span class="mi">20</span><span class="o">%</span>  <span class="mi">10080</span>
<span class="n">refresh_pattern</span> <span class="o">^</span><span class="n">gopher</span><span class="p">:</span>          <span class="mi">1440</span>   <span class="mi">0</span><span class="o">%</span>   <span class="mi">1440</span>
<span class="n">refresh_pattern</span> <span class="o">-</span><span class="n">i</span> <span class="p">(</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/|</span>\<span class="err">?</span><span class="p">)</span>    <span class="mi">0</span>   <span class="mi">0</span><span class="o">%</span>      <span class="mi">0</span>
<span class="n">refresh_pattern</span> <span class="o">.</span>                    <span class="mi">0</span>  <span class="mi">20</span><span class="o">%</span>   <span class="mi">4320</span>

<span class="c1"># Leave coredumps in the first cache dir</span>
<span class="n">coredump_dir</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">squid</span>

<span class="c1"># Tiempo de espera de cierre de conexiones</span>
<span class="c1"># al disminuirlo el apagado sera mas breve</span>
<span class="n">shutdown_lifetime</span> <span class="mi">12</span> <span class="n">seconds</span>
</code></pre></div>


<h3>Squid - balanceo</h3>
<p>Cree <code>squid-04-balanceo.conf</code>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># nano squid-04-balanceo.conf</span>
</code></pre></div>


<p>Ajuste el contenido de acuerdo a sus necesidades...</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">Se</span> <span class="n">usaran</span> <span class="n">esta</span> <span class="n">cantidad</span> <span class="n">de</span> <span class="n">cubos</span>
<span class="n">delay_pools</span> <span class="mi">2</span>

<span class="o">#</span> <span class="n">Hay</span> <span class="n">tres</span> <span class="n">tipos</span> <span class="n">de</span> <span class="n">clases</span>
<span class="o">#</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Tiene</span> <span class="n">un</span> <span class="n">unico</span> <span class="n">cubo</span> <span class="k">Global</span>
<span class="o">#</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">Tiene</span> <span class="n">un</span> <span class="n">cubo</span> <span class="k">Global</span> <span class="n">y</span> <span class="mi">256</span> <span class="n">cubos</span> <span class="n">individuales</span>
<span class="o">#</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">Tiene</span> <span class="n">un</span> <span class="n">cubo</span> <span class="k">Global</span><span class="p">,</span> <span class="mi">256</span> <span class="n">cubos</span> <span class="n">de</span> <span class="n">Red</span> <span class="n">y</span> <span class="mi">65536</span> <span class="n">individuales</span>
<span class="o">#</span> <span class="n">Declaracion</span> <span class="n">de</span> <span class="n">las</span> <span class="n">clases</span> <span class="n">de</span> <span class="n">los</span> <span class="n">cubos</span>
<span class="o">#</span>   <span class="n">delay_class</span> <span class="n">N</span> <span class="n">clase</span>
<span class="n">delay_class</span> <span class="mi">1</span> <span class="mi">1</span>
<span class="n">delay_class</span> <span class="mi">2</span> <span class="mi">2</span>

<span class="o">#</span> <span class="n">Los</span> <span class="n">tamanos</span> <span class="n">de</span> <span class="n">los</span> <span class="n">cubos</span> <span class="n">son</span> <span class="n">en</span> <span class="n">bytes</span>
<span class="o">#</span> <span class="n">El</span> <span class="n">contrato</span> <span class="n">con</span> <span class="n">Telmex</span> <span class="n">es</span> <span class="n">de</span> <span class="n">hasta</span> <span class="mi">10</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>
<span class="o">#</span> <span class="mi">1250000</span> <span class="n">bytes</span><span class="o">/</span><span class="n">seg</span> <span class="o">=</span>  <span class="mi">10</span><span class="p">.</span><span class="mi">0</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>
<span class="o">#</span>  <span class="mi">625000</span> <span class="n">bytes</span><span class="o">/</span><span class="n">seg</span> <span class="o">=</span>   <span class="mi">5</span><span class="p">.</span><span class="mi">0</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>
<span class="o">#</span>  <span class="mi">312500</span> <span class="n">bytes</span><span class="o">/</span><span class="n">seg</span> <span class="o">=</span>   <span class="mi">2</span><span class="p">.</span><span class="mi">5</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>
<span class="o">#</span>  <span class="mi">250000</span> <span class="n">bytes</span><span class="o">/</span><span class="n">seg</span> <span class="o">=</span>   <span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>
<span class="o">#</span>  <span class="mi">125000</span> <span class="n">bytes</span><span class="o">/</span><span class="n">seg</span> <span class="o">=</span>   <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>

<span class="o">#</span> <span class="n">Cubo</span> <span class="n">clase</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="o">/</span><span class="mi">5</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>
<span class="o">#</span> <span class="n">Pocos</span> <span class="n">equipos</span> <span class="n">y</span> <span class="n">grandes</span> <span class="n">descargas</span>
<span class="n">delay_parameters</span> <span class="mi">1</span> <span class="mi">1250000</span><span class="o">/</span><span class="mi">625000</span>

<span class="o">#</span> <span class="n">Cubo</span> <span class="n">clase</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">10</span><span class="o">/</span><span class="mi">10</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span> <span class="n">y</span> <span class="mi">2</span><span class="o">/</span><span class="mi">2</span> <span class="n">Mb</span><span class="o">/</span><span class="n">s</span>
<span class="o">#</span> <span class="n">Muchos</span> <span class="n">equipos</span> <span class="n">y</span> <span class="n">carga</span> <span class="n">balanceada</span>
<span class="n">delay_parameters</span> <span class="mi">2</span> <span class="mi">1250000</span><span class="o">/</span><span class="mi">1250000</span> <span class="mi">250000</span><span class="o">/</span><span class="mi">250000</span>

<span class="o">#</span> <span class="n">El</span> <span class="n">primer</span> <span class="n">cubo</span> <span class="n">es</span> <span class="n">para</span> <span class="n">localhost</span>
<span class="n">delay_access</span> <span class="mi">1</span> <span class="n">allow</span> <span class="n">DesdeLocalhost</span>

<span class="o">#</span> <span class="n">El</span> <span class="n">segundo</span> <span class="n">cubo</span> <span class="n">es</span> <span class="n">para</span> <span class="n">la</span> <span class="n">LAN</span>
<span class="n">delay_access</span> <span class="mi">2</span> <span class="n">allow</span> <span class="n">DesdeLAN</span>
</code></pre></div>


<h3>Squid - stios permitidos y prohibidos</h3>
<p>Baje las expresiones regulares para bloquear publicidad...</p>
<div class="highlight"><pre><span></span><code><span class="err"># wget &quot;http://pgl.yoyo.org/adservers/serverlist.php?hostformat=squid-dstdom-regex&amp;showintro=0&amp;mimetype=plaintext&quot; -O regexp-publicidad.txt</span>
</code></pre></div>


<p>Cree su lista de sitios de entera confianza <code>sitios-permitidos.txt</code>...</p>
<div class="highlight"><pre><span></span><code><span class="na">.wikipedia.org</span>
<span class="na">.mediawiki.org</span>
<span class="nf">wikimediafundation.org</span>
<span class="na">.ubuntu.com</span>
<span class="na">.fedoraproject.org</span>
<span class="nf">fedoramagazine.org</span>
<span class="na">.github.com</span>
<span class="na">.osuosl.org</span>
<span class="na">.movimientolibre.com</span>
</code></pre></div>


<p>Y su lista negra con sitios prohibidos <code>sitios-prohibidos.txt</code>...</p>
<div class="highlight"><pre><span></span><code><span class="na">.microsoft.com</span>
<span class="na">.windowsupdate.com</span>
<span class="na">.msftncsi.com</span>
</code></pre></div>


<h3>Políticas de SELinux</h3>
<p>Prepare el directorio para el caché...</p>
<div class="highlight"><pre><span></span><code><span class="c1"># mkdir /var/cache/squid</span>
<span class="c1"># chown squid /var/cache/squid</span>
<span class="c1"># squid -z -N -f /etc/squid/squid.conf</span>
</code></pre></div>


<p>Arranque el daemon...</p>
<div class="highlight"><pre><span></span><code><span class="err"># systemctl start squid.service</span>
<span class="err"># systemctl status squid.service</span>
</code></pre></div>


<p>En mi caso ha fallado porque las política de seguridad SELinux no permiten algunas acciones de Squid. Revise el estatus...</p>
<div class="highlight"><pre><span></span><code><span class="err"># systemctl status squid</span>
</code></pre></div>


<p>Me reporta este error...</p>
<div class="highlight"><pre><span></span><code><span class="c">Ipc::Mem::Segment::create failed to shm_open</span>
</code></pre></div>


<p>Al revisar los últimos registros en la bitácora...</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tail /var/log/audit/audit.log</span>
</code></pre></div>


<p>Aparece una negación...</p>
<div class="highlight"><pre><span></span><code><span class="err">type=AVC msg=audit(1529629815.011:337): avc:  denied  { unlink } for  pid=2086 comm=&quot;squid&quot; name=&quot;squid-cf__metadata.shm&quot; dev=&quot;tmpfs&quot; ino=32961 scontext=system_u:system_r:squid_t:s0 tcontext=unconfined_u:object_r:user_tmp_t:s0 tclass=file permissive=0</span>
</code></pre></div>


<p>Si gusta profundizar en <strong>SELinux</strong> lea <a href="https://docs-old.fedoraproject.org/en-US/Fedora/22/html/SELinux_Users_and_Administrators_Guide/index.html">Fedora 22 SELinux User's and Administrator's Guide</a>.</p>
<p><strong>Opción 1:</strong>: Crear una nueva política a partir de la bitácora. Instale <code>policycoreutils-python-utils</code>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># dnf install policycoreutils-python-utils</span>
</code></pre></div>


<p>Como <em>root</em> nos vamos al directorio <code>/root</code> o donde podamos crear archivos...</p>
<div class="highlight"><pre><span></span><code><span class="err"># cd /root</span>
</code></pre></div>


<p>1) Ejecute <code>audit2allow</code> alimentado por la bitácora <code>audit.log</code>...</p>
<div class="highlight"><pre><span></span><code><span class="c1"># audit2allow -M MYSQUIDPOLICY &lt; /var/log/audit/audit.log</span>
</code></pre></div>


<p>2) Lea el texto de la política creada</p>
<div class="highlight"><pre><span></span><code><span class="err"># cat MYSQUIDPOLICY.te</span>
</code></pre></div>


<p>3) Cargue la política, <strong>note que se usa el archivo pp</strong>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># semodule -i MYSQUIDPOLICY.pp</span>
</code></pre></div>


<p>4) Arranque el daemon...</p>
<div class="highlight"><pre><span></span><code><span class="err"># systemctl start squid.service</span>
<span class="err"># systemctl status squid.service</span>
</code></pre></div>


<p>5) Vuelva al paso uno si ha fallado el arranque de Squid.</p>
<p>Tuve que <strong>repetir siete veces</strong> este proceso para dar con la política correcta, que mostrando <code>MYSQUIDPOLICY7.te</code> es...</p>
<p><strong>Opción 2:</strong>: Cree la política a partir del archivo de texto.</p>
<p>Instale <strong>policycoreutils-devel</strong>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># dnf install policycoreutils-devel</span>
</code></pre></div>


<p>Cree <code>DnsmasqSquidPolicy.te</code>...</p>
<div class="highlight"><pre><span></span><code><span class="err"># cd /root</span>
<span class="err"># nano DnsmasqSquidPolicy.te</span>
</code></pre></div>


<p>Con este contenido...</p>
<div class="highlight"><pre><span></span><code><span class="n">module</span> <span class="n">DnsmasqSquidPolicy</span> <span class="mf">1.0</span><span class="p">;</span>

<span class="n">require</span> <span class="p">{</span>
        <span class="n">type</span> <span class="n">squid_t</span><span class="p">;</span>
        <span class="n">type</span> <span class="n">dnsmasq_t</span><span class="p">;</span>
        <span class="n">type</span> <span class="n">user_tmp_t</span><span class="p">;</span>
        <span class="n">type</span> <span class="n">var_t</span><span class="p">;</span>
        <span class="k">class</span> <span class="n">capability</span> <span class="n">dac_override</span><span class="p">;</span>
        <span class="k">class</span> <span class="n">file</span> <span class="p">{</span> <span class="n">append</span> <span class="n">create</span> <span class="n">getattr</span> <span class="n">open</span> <span class="n">read</span> <span class="n">rename</span> <span class="n">unlink</span> <span class="n">write</span> <span class="p">};</span>
<span class="p">}</span>

<span class="c1">#============= dnsmasq_t ==============</span>

<span class="n">allow</span> <span class="n">dnsmasq_t</span> <span class="bp">self</span><span class="p">:</span><span class="n">capability</span> <span class="n">dac_override</span><span class="p">;</span>

<span class="c1">#============= squid_t ==============</span>

<span class="n">allow</span> <span class="n">squid_t</span> <span class="n">user_tmp_t</span><span class="p">:</span><span class="n">file</span> <span class="n">unlink</span><span class="p">;</span>
<span class="n">allow</span> <span class="n">squid_t</span> <span class="n">var_t</span><span class="p">:</span><span class="n">file</span> <span class="n">unlink</span><span class="p">;</span>
<span class="n">allow</span> <span class="n">squid_t</span> <span class="n">var_t</span><span class="p">:</span><span class="n">file</span> <span class="p">{</span> <span class="n">append</span> <span class="n">create</span> <span class="n">getattr</span> <span class="n">open</span> <span class="n">read</span> <span class="n">rename</span> <span class="n">write</span> <span class="p">};</span>
</code></pre></div>


<p>Compile e instale...</p>
<div class="highlight"><pre><span></span><code><span class="err"># checkmodule -M -m -o DnsmasqSquidPolicy.mod DnsmasqSquidPolicy.te</span>
<span class="err"># semodule_package -o DnsmasqSquidPolicy.pp -m DnsmasqSquidPolicy.mod</span>
<span class="err"># semodule -i DnsmasqSquidPolicy.pp</span>
</code></pre></div>


<p>Arranque el daemon...</p>
<div class="highlight"><pre><span></span><code><span class="err"># systemctl start squid.service</span>
<span class="err"># systemctl status squid.service</span>
</code></pre></div>


<h3>Arranque al encender y muro de fuego</h3>
<p>Habilite que inicie el <em>daemon</em> al encender...</p>
<div class="highlight"><pre><span></span><code><span class="err"># systemctl enable squid</span>
</code></pre></div>


<p>Verifique que el muro de fuego tenga abierto el servicio <strong>squid</strong> en la LAN...</p>
<div class="highlight"><pre><span></span><code><span class="err"># firewall-cmd --zone=internal --list-services</span>
<span class="err">ssh mdns samba-client dhcpv6-client cockpit dns squid dhcp</span>
</code></pre></div>


<h3>Hacer que el servidor YA NO SEA un ruteador</h3>
<p>Al estar habilitado el enmascaramiento, cualquier equipo puede acceder a Internet sin pasar por el proxy. Consulte con...</p>
<div class="highlight"><pre><span></span><code><span class="err"># firewall-cmd --zone=external --query-masquerade</span>
</code></pre></div>


<p>Deshabilite el enmascaramiento con...</p>
<div class="highlight"><pre><span></span><code><span class="err"># firewall-cmd --zone=external --remove-masquerade</span>
</code></pre></div>


<p>Haga pruebas con su navegador de internet en un equipo en la red local. Si configura <em>sin proxy</em> no debería tener Internet. Luego configure el proxy y pruebe que funcione.</p>
<p>Si tiene éxito, haga los cambios permanantes...</p>
<div class="highlight"><pre><span></span><code><span class="err"># firewall-cmd --runtime-to-permanent</span>
</code></pre></div>


<h3>Continuación...</h3>
<p><a href="https://movimientolibre.com/apuntes/fedora-server-28-parte-06/">Vaya a la parte 6, configuración del proxy en los clientes</a>.</p>
                </article>
            </div>
            <div class="col-md-4">
                <aside>
                    <div class="card my-4 movimientolibre-card aside-about">
                        <h5 class="card-header movimientolibre-card-header">A cerca de</h5>
                        <div class="card-body">
                            <p class="card-text">
                                Este es un sitio web que busca divulgar
                                conocimiento y promover el uso de software libre.
                                Su creador es reconocido como desarrollador que
                                fabrica estas herramientas tanto para entidades
                                públicas como privadas.
                            </p>
                        </div>
                    </div>
                    <div class="card my-4 movimientolibre-card">
                        <h5 class="card-header movimientolibre-card-header">Etiquetas</h5>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li><a href="https://movimientolibre.com/tag/astronomia.html">astronomía</a></li>
                                <li><a href="https://movimientolibre.com/tag/ciencia-de-datos.html">ciencia de datos</a></li>
                                <li><a href="https://movimientolibre.com/tag/conferencias.html">conferencias</a></li>
                                <li><a href="https://movimientolibre.com/tag/contenedores.html">contenedores</a></li>
                                <li><a href="https://movimientolibre.com/tag/desarrollo.html">desarrollo</a></li>
                                <li><a href="https://movimientolibre.com/tag/educacion.html">educación</a></li>
                                <li><a href="https://movimientolibre.com/tag/fedora.html">fedora</a></li>
                                <li><a href="https://movimientolibre.com/tag/flisol.html">flisol</a></li>
                                <li><a href="https://movimientolibre.com/tag/gentoo-linux.html">gentoo linux</a></li>
                                <li><a href="https://movimientolibre.com/tag/git.html">git</a></li>
                                <li><a href="https://movimientolibre.com/tag/gnu-linux.html">gnu linux</a></li>
                                <li><a href="https://movimientolibre.com/tag/gulag.html">gulag</a></li>
                                <li><a href="https://movimientolibre.com/tag/hardware.html">hardware</a></li>
                                <li><a href="https://movimientolibre.com/tag/kde.html">kde</a></li>
                                <li><a href="https://movimientolibre.com/tag/kernel-linux.html">kernel linux</a></li>
                                <li><a href="https://movimientolibre.com/tag/latex.html">latex</a></li>
                                <li><a href="https://movimientolibre.com/tag/markdown.html">markdown</a></li>
                                <li><a href="https://movimientolibre.com/tag/php.html">php</a></li>
                                <li><a href="https://movimientolibre.com/tag/politica.html">política</a></li>
                                <li><a href="https://movimientolibre.com/tag/postgresql.html">postgresql</a></li>
                                <li><a href="https://movimientolibre.com/tag/python.html">python</a></li>
                                <li><a href="https://movimientolibre.com/tag/ruby.html">ruby</a></li>
                                <li><a href="https://movimientolibre.com/tag/servidores.html">servidores</a></li>
                                <li><a href="https://movimientolibre.com/tag/software-libre.html">software libre</a></li>
                                <li><a href="https://movimientolibre.com/tag/vida-cotidiana.html">vida cotidiana</a></li>
                                <li><a href="https://movimientolibre.com/tag/wallpapers.html">wallpapers</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card my-4 movimientolibre-card">
                        <h5 class="card-header movimientolibre-card-header">Buscar</h5>
                        <div class="card-body">
                            <script>
                                (function() {
                                    var cx = '015464194519155410478:jqayrodgycs';
                                    var gcse = document.createElement('script');
                                    gcse.type = 'text/javascript';
                                    gcse.async = true;
                                    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                                    var s = document.getElementsByTagName('script')[0];
                                    s.parentNode.insertBefore(gcse, s);
                                })();
                            </script>
                            <gcse:search></gcse:search>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
    <footer class="text-muted">
        <div class="container">
            <hr>
            <p>
                Copyright &copy; 2006-2020 Guillermo Valdés Lozano.
                Protegidos por la licencia <a href="https://movimientolibre.com/licencias/gfdl-es/">GFDL</a>.
                Se otorga permiso para copiar, distribuir y/o modificar estos documentos.
                Sitio web elaborado con <a href="https://blog.getpelican.com/">Pelican</a> que es programado en <a href="https://python.org/">Python</a>; el código fuente está en <a href="https://github.com/MovimientoLibre/plataforma.web">GitHub</a> protegido por la licencia <a href="https://movimientolibre.com/licencias/gpl-2-es/">GPLv3</a>.
            </p>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script src="https://movimientolibre.com/theme/js/movimiento-libre.js"></script>
</body>
</html>
