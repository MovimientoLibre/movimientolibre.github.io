<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Instalación de CentOS para virtualizar - Movimiento Libre</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" href="imagenes/icon-hires.png" sizes="192x192">
  <link rel="icon" href="imagenes/icon-normal.png" sizes="128x128">
  <link rel="apple-touch-icon" href="imagenes/apple-touch-icon.png">
  <link rel="apple-touch-icon" href="imagenes/apple-touch-icon-76x76.png" sizes="76x76">
  <link rel="apple-touch-icon" href="imagenes/apple-touch-icon-120x120.png" sizes="120x120">
  <link rel="apple-touch-icon" href="imagenes/apple-touch-icon-152x152.png" sizes="152x152">
  <link rel="apple-touch-icon" href="imagenes/apple-touch-icon-180x180.png" sizes="180x180">
  <link rel="alternate" href="rss.xml" type="application/rss+xml" title="Movimiento Libre">
  <link rel="stylesheet" href="http://www.movimientolibre.com/theme/vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="http://www.movimientolibre.com/theme/vendor/font-awesome/css/font-awesome.min.css" type="text/css">
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' type='text/css'>
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' type='text/css'>
  <link rel="stylesheet" href="http://www.movimientolibre.com/theme/css/clean-blog.min.css">
  <link rel="stylesheet" href="http://www.movimientolibre.com/dist/css/movimientolibre.css">
</head>

<body>

  <!-- Navigation start -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="http://www.movimientolibre.com/index.html">Movimiento Libre</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fa fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item"><a class="nav-link" href="http://www.movimientolibre.com/index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="http://www.movimientolibre.com/portafolio/soluciones.html">Portafolio</a></li>
          <li class="nav-item"><a class="nav-link" href="http://www.movimientolibre.com/category/apuntes.html">Apuntes</a></li>
          <li class="nav-item"><a class="nav-link" href="http://www.movimientolibre.com/category/articulos.html">Artículos</a></li>
          <li class="nav-item"><a class="nav-link" href="http://www.movimientolibre.com/category/presentaciones.html">Presentaciones</a></li>
          <li class="nav-item"><a class="nav-link" href="http://www.movimientolibre.com/contacto/contacto.html">Contacto</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- Navigation end -->

  <!-- Main content start -->
  <header class="masthead" style="background-image: url('http://www.movimientolibre.com/imagenes/apuntes.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Instalación de CentOS para virtualizar</h1>
            <h2 class="subheading"><p>Instalar CentOS con lo mínimo necesario para virtualizar con KVM. Teniendo en mente que sólo va a llegar a Terminal, es decir, sin interfaz gráfica o GUI. La administración será vía OpenSSH y por el Administrador de Virtualizaciones desde otro equipo.</p></h2>
            <span class="meta">2014-01-30 10:20:00-06:00</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">

          <div class="alert alert-dark alert-dismissible fade show" role="alert">
            <a href="http://www.movimientolibre.com/portafolio/soluciones.html">
              Conozca las nuevas <strong>soluciones en desarrollo de software</strong> a la medida.
            </a>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <p><a href="https://www.centos.org/">CentOS</a> es una distribución GNU/Linux mantenida por la comunidad a partir del código libre de <a href="https://www.redhat.com/">Red Hat</a>. De una forma práctica, <strong>CentOS</strong> es lo mismo que <strong>Red Hat</strong> pero sin su marca comercial ni soporte técnico de paga. La estabilidad y confiabilidad de CentOS lo hacen la mejor opción para sistema operativo base de un servidor cuyo fin sea virtualizar. Recientemente se ha anunciado el apoyo directo de Red Hat a la comunidad de CentOS; de lo cual esperamos muchas ganancias para todos.</p>
<h3>Objetivo</h3>
<p>Instalar CentOS con lo mínimo necesario para virtualizar con KVM. Teniendo en mente que sólo va a llegar a Terminal, es decir, sin interfaz gráfica o <em>GUI</em>. La administración será vía <strong>OpenSSH</strong> y por el <strong>Administrador de Virtualizaciones</strong> desde otro equipo.</p>
<h3>Requerimientos</h3>
<ul>
<li>Una computadora o servidor con capacidad para virtualizar en hardware. Consulte el sitio del <a href="http://www.linux-kvm.org/page/Main_Page">KVM</a> para saber más.</li>
<li>Un mínimo de 2 GB de RAM.</li>
<li>Disco duro dedicado de por lo menos 100 GB.</li>
<li>Descargar y quemar el CD Minimal de <a href="https://www.centos.org/">CentOS</a>.</li>
</ul>
<h3>Arranque con el CD Minimal</h3>
<p>Hay varios tipos de discos ISO de CentOS para cada versión. Desde DVD completos a CD para instarar por red. Su servidor recomienda usar el <strong>CD Minimal x86_64</strong> ya que contiene lo básico para llegar a una terminal. Considere que es poco útil y riesgoso tener una interfaz gráfica en un servidor.</p>
<p>Durante la instalación elija estas opciones:</p>
<ul>
<li>GRUB: Install or Update</li>
<li>Idioma: Spanish</li>
<li>Teclado: Latinoamericano</li>
<li>Special Storage Devices</li>
<li>Use All Space</li>
</ul>
<p>Ya que haga su primer arranque, a partir de lo instalado en el disco duro, continúe con los siguientes pasos.</p>
<h3>Levante la red</h3>
<p>Por defecto no levanta ningún dispositivo de red. Como partimos del <strong>CD Minimal</strong> necesitaremos salida a internet para bajar el software. Para configurar el dispositivo de red <strong>eth0</strong> edite:</p>
<div class="highlight"><pre><span></span># cd /etc/sysconfig/network-scripts
# vi ifcfg-eth0
</pre></div>


<p>Si quiere usar una <strong>dirección IP fija</strong>, por ejemplo 192.168.0.250 con ruteador 192.168.0.254 (conserve el <strong>HWADDR</strong>):</p>
<div class="highlight"><pre><span></span>DEVICE=eth0
HWADDR=xx:xx:xx:xx:xx:xx
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
IPADDR=192.168.0.250
NETMASK=255.255.255.0
GATEWAY=192.168.0.254
</pre></div>


<p>Luego debe configurar cuáles serán sus servidores DNS:</p>
<div class="highlight"><pre><span></span>vi /etc/resolv.conf
</pre></div>


<p>Escriba el dominio si lo usa, luego cada servidor DNS como una línea <em>nameserver</em>. En el siguiente ejemplo se usa un dominio <em>oficina.lan</em> y las direcciones IP de los <a href="https://developers.google.com/speed/public-dns/?hl=es-">DNS de Google</a>:</p>
<div class="highlight"><pre><span></span>domain oficina.lan
search oficina.lan
nameserver 8.8.8.8
nameserver 8.8.4.4
</pre></div>


<p>En cambio, para solicitar una <strong>dirección IP dinámica</strong> al servidor DHCP se usa <strong>BOOTPROTO</strong>:</p>
<div class="highlight"><pre><span></span>DEVICE=eth0
HWADDR=xx:xx:xx:xx:xx:xx
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=dhcp
</pre></div>


<p>Después de cambiar estos archivos de configuración, reinicie el servicio de red para hacerlos efectivos.</p>
<div class="highlight"><pre><span></span># service network restart
</pre></div>


<p>Revise la dirección IP obtenida con:</p>
<div class="highlight"><pre><span></span># ifconfig eth0
</pre></div>


<p>Revise la tabla de ruteo también:</p>
<div class="highlight"><pre><span></span># route -n
</pre></div>


<h3>Configure proxy de ser necesario</h3>
<p>En caso de tener internet a través de un <em>proxy</em> debe de editar el archivo de configuración de <strong>Yum</strong>:</p>
<div class="highlight"><pre><span></span># vi /etc/yum.conf
</pre></div>


<p>Agregue una línea como la siguiente para definir el servidor <em>proxy</em>. Cambie <em>proxy.oficina.lan</em> por el nombre o dirección IP del <em>proxy</em>.</p>
<div class="highlight"><pre><span></span>proxy=http://proxy.oficina.lan:3128
</pre></div>


<h3>Actualize e instale el software para virtualizar</h3>
<p>Ejecute estos dos comandos para actualizar las listas de los repositorios de CentOS:</p>
<div class="highlight"><pre><span></span># yum check-update
# yum update
</pre></div>


<p>Por ser programas indispensables, instale <strong>nano</strong>, <strong>sudo</strong> y <strong>man</strong>:</p>
<div class="highlight"><pre><span></span># yum install nano sudo man
</pre></div>


<p>Yum ofrece la instalación por <strong>grupos</strong>, éstos son conjuntos de paquetes de software. Para listar los <strong>grupos</strong> ejecute este comando:</p>
<div class="highlight"><pre><span></span># yum grouplist
</pre></div>


<p>Instale los <strong>grupos</strong> de paquetes que tienen que ver con virtualización en servidor:</p>
<div class="highlight"><pre><span></span># yum groupinstall &quot;Virtualización&quot;
# yum groupinstall &quot;Plataforma de virtualización&quot;
# yum install tunctl
</pre></div>


<p>Esta descarga es grande y puede demorar algo de tiempo, dependiendo de su velocidad de internet. Al terminar de instalar reinicie el servidor para asegurar que las actualizaciones y el nuevo software estén trabajando. Reinicie con:</p>
<div class="highlight"><pre><span></span># shutdown -r 1 &amp;
# exit
</pre></div>


<h3>Configuración del bridge</h3>
<p>Cree el archivo <strong>ifcfg-br0</strong> con la configuración para el <em>bridge</em>:</p>
<div class="highlight"><pre><span></span># cd /etc/sysconfig/network-scripts/
# nano ifcfg-br0
</pre></div>


<p>Si <strong>br0</strong> va a tener una dirección IP estática, use lo siguiente como contenido del archivo <strong>ifcfg-br0</strong> ajustando la dirección IP, la máscara y el <em>gateway</em> a sus necesidades:</p>
<div class="highlight"><pre><span></span>DEVICE=br0
TYPE=Bridge
ONBOOT=yes
DELAY=0
NM_CONTROLLED=no
IPADDR=192.168.0.250
NETMASK=255.255.255.0
GATEWAY=192.168.0.254
</pre></div>


<p>Luego, hay que editar el archivo <strong>ifcfg-eth0</strong> para indicar que ese dispositivo de red se va conectar al <em>bridge</em>:</p>
<div class="highlight"><pre><span></span># nano ifcfg-eth0
</pre></div>


<p>Con este contenido:</p>
<div class="highlight"><pre><span></span>DEVICE=&quot;eth0&quot;
HWADDR=&quot;xx:xx:xx:xx:xx:xx&quot;
NM_CONTROLLED=&quot;no&quot;
ONBOOT=&quot;yes&quot;
BRIDGE=&quot;br0&quot;
</pre></div>


<h3>Configure el muro de fuego</h3>
<p>Para que se permitan todas las comunicaciones que fluyan a través del <em>bridge</em> <strong>br0</strong> es necesario indicarlo. Edite la configuración del muro de fuego:</p>
<div class="highlight"><pre><span></span># cd /etc/sysconfig/
# nano iptables
</pre></div>


<p>Agregue la línea <strong>-A FORWARD -i br0 -j ACCEPT</strong> como la primer línea con <em>FORWARD</em>, por ejemplo:</p>
<div class="highlight"><pre><span></span>*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -i br0 -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
</pre></div>


<p>Reinicie el muro de fuego</p>
<div class="highlight"><pre><span></span># service iptables restart
</pre></div>


<p>Verifique...</p>
<div class="highlight"><pre><span></span># iptables -L -v -n
</pre></div>


<h3>Destruir el puente virbr0</h3>
<p>Como se va a levantar el <em>bridge</em> <strong>br0</strong> desde el sistema operativo, sale sobrando el puente que por defecto habilita <strong>libvirt</strong>. Para observar que esta presente <strong>virtbr0</strong> ejecute:</p>
<div class="highlight"><pre><span></span># ifconfig
</pre></div>


<p>Notará que hay un dispositivo <strong>virbr0</strong> con una dirección IP indpenediente (p.e. 192.168.122.1). El comando <strong>virsh net-list</strong> mostrará las redes para las virtualizaciones:</p>
<div class="highlight"><pre><span></span># virsh net-list
Nombre               Estado     Inicio automático Persistente
--------------------------------------------------
default              activo     si            si
</pre></div>


<p>Para destruir la red <strong>default</strong> ejecute:</p>
<div class="highlight"><pre><span></span># virsh net-destroy default
# virsh net-undefine default
</pre></div>


<p>Revise:</p>
<div class="highlight"><pre><span></span># virsh net-list
# ifconfig
</pre></div>


<h3>Reinicie el servidor</h3>
<p>Para asegurar que las actualizaciones y configuraciones inicien al encender, reinicie el servidor.</p>
<div class="highlight"><pre><span></span># shutdown -r 1 &amp;
# exit
</pre></div>


<p>Y revise que los dispositivos de red y los servicios estén trabajando como debe.</p>
<div class="highlight"><pre><span></span># ifconfig br0
# ifconfig eth0
# brctl show
</pre></div>


<h3>Configurar libvirt para que use br0</h3>
<p>Para que las virtualizaciones usen el <em>bridge</em> del sistema operativo, cree un archivo de configuración <strong>xml</strong>. Use el nombre de archivo que guste:</p>
<div class="highlight"><pre><span></span># cd /root
# nano bridge-br0.xml
</pre></div>


<p>Escriba el siguiente contenido, cambiando <strong>bridge-br0</strong> por el nombre que usted prefiera:</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;network&gt;</span>
  <span class="nt">&lt;name&gt;</span>bridge-br0<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&quot;bridge&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">&quot;br0&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/network&gt;</span>
</pre></div>


<p>Para cargar ese archivo <strong>xml</strong> en <strong>libvirt</strong> ejecute...</p>
<div class="highlight"><pre><span></span># virsh net-define bridge-br0.xml
La red bridge-br0 se encuentra definida desde bridge-br0.xml
</pre></div>


<p><strong>Atención:</strong> En este momento, el comando <strong># virsh net-list</strong> NO mostrará esta red. En cambio, con el parámetro <strong>--all</strong> sí lo verá:</p>
<div class="highlight"><pre><span></span># virsh net-list --all
Nombre               Estado     Inicio automático
-----------------------------------------
bridge-br0           activo     no
</pre></div>


<p>Puede solicitar información detallada de una red con el comando <strong>virsh net-info</strong> seguido por el nombre de la red.</p>
<div class="highlight"><pre><span></span># virsh net-info bridge-br0
Nombre          bridge-br0
UUID            xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Activar:        no
Persistente:    si
Autoinicio:     no
Puente:         br0
</pre></div>


<p>Observe que Activar y Autoinicio están en <strong>no</strong>. Configure que esta red se habilite al inicio, con:</p>
<div class="highlight"><pre><span></span># virsh net-autostart bridge-br0
La red bridge-br0-dgspm ha sido marcada para iniciarse automáticamente
</pre></div>


<p>Luego, arranque esta red con:</p>
<div class="highlight"><pre><span></span># virsh net-start bridge-br0
La red bridge-br0 se ha iniciado
</pre></div>


<p>Verifique que Activar, Persistente y Autoinicio estén en <strong>si</strong>:</p>
<div class="highlight"><pre><span></span># virsh net-info bridge-br0
Nombre          bridge-br0
UUID            xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Activar:        si
Persistente:    si
Autoinicio:     si
Puente:         br0
</pre></div>


<p>También con el comando <strong>virsh net-list</strong>:</p>
<div class="highlight"><pre><span></span># virsh net-list
Nombre               Estado     Inicio automático Persistente
--------------------------------------------------
bridge-br0           activo     si            si
</pre></div>


<p>En dado caso de que necesite recuperar la información de la red en formato <strong>xml</strong>, use el comando <strong>virsh net-dumpxml</strong>:</p>
<div class="highlight"><pre><span></span># virsh net-dumpxml bridge-br0
<span class="nt">&lt;network&gt;</span>
  <span class="nt">&lt;name&gt;</span>bridge-br0<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;uuid&gt;</span>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<span class="nt">&lt;/uuid&gt;</span>
  <span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#39;bridge&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">&#39;br0&#39;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/network&gt;</span>
</pre></div>


<h3>Agregue un usuario común</h3>
<p>Como en todo equipo de escritorio o servidor, es ampliamente recomendable dar de alta un usuario común y no usar root para todo. Para dar de alta un usuario ejecute el comando <strong>useradd</strong> con los grupos a los que necesite pertenecer y cambie <em>minombre</em> por su nombre para ingresar.</p>
<div class="highlight"><pre><span></span># useradd -g users -G tty,lp,wheel,uucp,games,video,audio,cdrom,kvm,qemu -m minombre
</pre></div>


<p>Establezca la contraseña:</p>
<div class="highlight"><pre><span></span># passwd minombre
</pre></div>


<h3>Administrador de virtualizaciones</h3>
<p>Desde un equipo con interfaz gráfica y el <strong>VirtManager</strong> instalado administramos las virtaliuzaciones.</p>
<p><img alt="Administrador de Virtualizaciones" src="centos-instalacion-para-virtualizar/administrador-virtualizaciones-1.png"></p>
<p>Establezca la conexión vía OpenSSH. Le solicitará la contraseña <em>root</em>:</p>
<p><img alt="Administrador de Virtualizaciones nueva conexion" src="centos-instalacion-para-virtualizar/administrador-virtualizaciones-2-nueva-conexion.png"></p>
<p>Verifique que en los detalles se use la configuración de red con el <em>bridge</em> <strong>br0</strong>:</p>
<p><img alt="Administrador de Virtualizaciones detalle" src="centos-instalacion-para-virtualizar/administrador-virtualizaciones-3-detalles-redes.png"></p>

        </div>
      </div>
    </div>
  </article>
  <!-- Main content end -->

  <hr>

  <!-- Footer start -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            <li class="list-inline-item">
              <a href="https://twitter.com/guivaloz">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            <li class="list-inline-item">
              <a href="https://www.linkedin.com/in/guivaloz">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            <li class="list-inline-item">
              <a href="https://github.com/guivaloz">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            <li class="list-inline-item">
              <a href="https://plus.google.com/+GuillermoVald%C3%A9sLozano">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          </ul>
          <p class="copyright text-muted">
            Copyright &copy; 2006-2018 Guillermo Valdés Lozano.<br>
            Se otorga permiso para copiar, distribuir y/o modificar estos documentos.
            Protegidos por la licencia <a href="http://www.movimientolibre.com/licencias/gfdl-es.html">GFDL</a>.<br>
            Sitio web elaborado con <a href="http://getpelican.com/">Pelican</a>,
            que es programado en <a href="http://python.org">Python</a>.
            Tema <a href="https://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a>
            creado por <a href="https://startbootstrap.com/">Start Bootstrap</a>.
          </p>
        </div>
      </div>
    </div>
  </footer>
  <!-- Footer end -->

  <!-- Javascript start -->
  <script src="http://www.movimientolibre.com/theme/vendor/jquery/jquery.min.js"></script>
  <script src="http://www.movimientolibre.com/theme/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="http://www.movimientolibre.com/theme/js/clean-blog.min.js"></script>
  <!-- Javascript end -->

</body>

</html>